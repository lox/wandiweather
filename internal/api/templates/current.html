<header>
    <div class="location">Wandiligong</div>
    <div class="time">{{.LastUpdated.Format "Mon 3:04 PM"}}</div>
</header>

<!-- NOW: Current conditions -->
<div class="hero">
    {{if gt .ValleyTemp 0.0}}
    <div class="temp-now">{{printf "%.0f" .ValleyTemp}}<span class="unit">Â°</span></div>
    {{if .TempChangeRate}}
    <div class="temp-trend {{if gt (deref .TempChangeRate) 0.0}}rising{{else}}falling{{end}}">
        {{if gt (deref .TempChangeRate) 0.0}}+{{else}}-{{end}}{{printf "%.1f" (abs (deref .TempChangeRate))}}Â°C/hr
    </div>
    {{end}}
    {{if .Primary}}
    <div class="conditions-inline">
        {{if .Primary.Humidity.Valid}}<span>Humidity {{.Primary.Humidity.Int64}}%</span>{{end}}
        {{if .FeelsLike}}<span>Feels {{printf "%.0f" (deref .FeelsLike)}}Â°</span>{{end}}
        {{if .Primary.Dewpoint.Valid}}<span>Dew {{printf "%.0f" .Primary.Dewpoint.Float64}}Â°</span>{{end}}
        {{if .Primary.WindGust.Valid}}<span>ğŸ’¨ {{printf "%.0f" .Primary.WindGust.Float64}} km/h</span>{{end}}
        {{if .Primary.UV.Valid}}{{if gt .Primary.UV.Float64 0.0}}<span>â˜€ï¸ UV {{printf "%.0f" .Primary.UV.Float64}}</span>{{else if .Moon}}<span>{{.Moon.Emoji}} {{.Moon.Illumination}}%</span>{{end}}{{end}}
    </div>
    {{end}}
    {{else}}
    <div class="temp-now">â€”<span class="unit">Â°</span></div>
    {{end}}
</div>

<!-- TODAY: Forecast -->
{{if .TodayForecast}}
<div class="today-forecast">
    <div class="forecast-header" onclick="document.getElementById('forecast-explain').classList.toggle('show')">Today's Forecast <span class="info-icon" title="Click for details">â“˜</span></div>
    <div class="forecast-narrative">{{.TodayForecast.Narrative}}</div>
    <div class="forecast-range">
        <div class="range-item">
            <span class="range-value low">{{printf "%.0f" .TodayForecast.TempMin}}Â°</span>
            <span class="range-label">Low</span>
        </div>
        <div class="range-item">
            <span class="range-value high">{{if and .TodayForecast.NowcastApplied (ne .TodayForecast.TempMaxRaw .TodayForecast.TempMax)}}<span class="revised-from" title="Revised based on morning observations">{{printf "%.0f" .TodayForecast.TempMaxRaw}}Â°</span>{{end}}{{printf "%.0f" .TodayForecast.TempMax}}Â°</span>
            <span class="range-label">High</span>
        </div>
        {{if .TodayForecast.HasPrecip}}
        <div class="range-item">
            <span class="range-value rain">{{.TodayForecast.PrecipChance}}%</span>
            <span class="range-label">Rain</span>
        </div>
        {{end}}
    </div>
    <div id="forecast-explain" class="forecast-explanation">
        <div class="explain-title">How this forecast is calculated</div>
        <div class="explain-row">
            <span class="explain-label">High:</span>
            <span class="explain-value">
                {{printf "%.0f" .TodayForecast.Explanation.MaxRaw}}Â° ({{.TodayForecast.Explanation.MaxSource | upper}})
                {{if ne .TodayForecast.Explanation.MaxBiasApplied 0.0}} â†’ {{printf "%+.1f" (neg .TodayForecast.Explanation.MaxBiasApplied)}}Â° bias{{end}}
                {{if .TodayForecast.NowcastApplied}} â†’ {{printf "%+.1f" .TodayForecast.Explanation.MaxNowcast}}Â° nowcast{{end}}
                = <strong>{{printf "%.0f" .TodayForecast.Explanation.MaxFinal}}Â°</strong>
            </span>
        </div>
        <div class="explain-row">
            <span class="explain-label">Low:</span>
            <span class="explain-value">
                {{printf "%.0f" .TodayForecast.Explanation.MinRaw}}Â° ({{.TodayForecast.Explanation.MinSource | upper}})
                {{if ne .TodayForecast.Explanation.MinBiasApplied 0.0}} â†’ {{printf "%+.1f" (neg .TodayForecast.Explanation.MinBiasApplied)}}Â° bias{{end}}
                = <strong>{{printf "%.0f" .TodayForecast.Explanation.MinFinal}}Â°</strong>
            </span>
        </div>
    </div>
    {{if .TodayStats}}
    <div class="observed-progress">
        So far: <span class="obs-temp" {{if .TodayStats.MinTempTime}}title="at {{.TodayStats.MinTempTime}}"{{end}}>{{printf "%.0f" .TodayStats.MinTemp}}Â°</span> â€“ <span class="obs-temp" {{if .TodayStats.MaxTempTime}}title="at {{.TodayStats.MaxTempTime}}"{{end}}>{{printf "%.0f" .TodayStats.MaxTemp}}Â°</span>{{if .TodayStats.HasWind}}, max {{if gt .TodayStats.MaxGust .TodayStats.MaxWind}}{{printf "%.0f" .TodayStats.MaxGust}}{{else}}{{printf "%.0f" .TodayStats.MaxWind}}{{end}} km/h winds{{end}}{{if .TodayStats.HasRain}}, {{printf "%.1f" .TodayStats.RainTotal}}mm rain{{end}}
    </div>
    {{end}}
</div>
{{end}}

{{if .Inversion}}
{{if .Inversion.Active}}
<div class="inversion active">
    <div class="inversion-title">âš ï¸ Inversion Active</div>
    <div class="inversion-detail">
        Valley {{printf "%.1f" .Inversion.ValleyAvg}}Â° Â· Upper {{printf "%.1f" .Inversion.UpperAvg}}Â° 
        ({{printf "%+.1f" .Inversion.Strength}}Â° anomaly)
    </div>
</div>
{{end}}
{{end}}

<div class="forecast-section" hx-get="/partials/forecast" hx-trigger="load, every 3600s" hx-swap="innerHTML"></div>

<div class="chart-toggle">
    <a onclick="toggleChart()">Show 24hr chart</a>
</div>

<div id="chart-section" class="chart-section" hx-get="/partials/chart" hx-trigger="revealed" hx-swap="innerHTML"></div>

<div class="stations-toggle">
    <a onclick="toggleStations()">Show all stations</a>
</div>

<div id="stations-grid" class="stations-grid">
    <div class="stations-table">
        <div class="station-header">
            <span class="station-col-name">Station</span>
            <span class="station-col-temp">Temp</span>
            <span class="station-col-elev">Elev</span>
            <span class="station-col-coords">Location</span>
        </div>
        {{range .AllStations}}
        <div class="station-row{{if .Station.IsPrimary}} primary{{end}}">
            <span class="station-col-name">
                <a href="https://www.wunderground.com/dashboard/pws/{{.Station.StationID}}" target="_blank" rel="noopener">{{.Station.StationID}}</a>
                <span class="station-label">{{.Station.Name}}</span>
            </span>
            <span class="station-col-temp">{{if .Obs}}{{if .Obs.Temp.Valid}}{{printf "%.1f" .Obs.Temp.Float64}}Â°{{else}}â€”{{end}}{{else}}â€”{{end}}</span>
            <span class="station-col-elev">{{printf "%.0f" .Station.Elevation}}m</span>
            <span class="station-col-coords">
                <a href="https://www.google.com/maps?q={{.Station.Latitude}},{{.Station.Longitude}}" target="_blank" rel="noopener">{{printf "%.3f" .Station.Latitude}}, {{printf "%.3f" .Station.Longitude}}</a>
            </span>
        </div>
        {{end}}
    </div>
</div>

<div class="updated">
    Updated {{.LastUpdated.Format "3:04:05 PM"}} Â· <a href="/accuracy">Forecast accuracy</a> Â· <a href="mailto:lachlan@ljd.cc">Email me</a>
</div>
