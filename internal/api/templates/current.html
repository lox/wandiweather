<header>
    <div class="location">Wandiligong
        {{if .FireDanger}}
        <span class="fire-danger {{.FireDanger.Rating.CSSClass}}">
            <span class="fdr-icon">üî•</span>{{.FireDanger.Rating}}{{if .FireDanger.TotalFireBan}}<span class="tfb-badge">TFB</span>{{end}}
        </span>
        {{end}}
    </div>
    <div class="time">{{.LastUpdated.Format "Mon 3:04 PM"}}</div>
</header>

{{if .UrgentAlerts}}
<div class="emergency-alerts">
    {{range .UrgentAlerts}}
    <a href="{{.URL}}" target="_blank" rel="noopener" class="alert-banner {{.SeverityClass}}">
        <span class="alert-icon">{{if eq .Severity 0}}üö®{{else}}‚ö†Ô∏è{{end}}</span>
        <div class="alert-content">
            <strong>{{.SeverityName}}</strong>
            <span class="alert-detail">{{.Category}}{{if .SubCategory}}: {{.SubCategory}}{{end}} ‚Äî {{.Location}} ({{printf "%.0f" .Distance}}km away)</span>
        </div>
        <span class="alert-arrow">‚Üí</span>
    </a>
    {{end}}
</div>
{{end}}

<!-- NOW: Current conditions -->
<div class="hero">
    {{if gt .ValleyTemp 0.0}}
    <div class="temp-now">{{printf "%.0f" .ValleyTemp}}<span class="unit">¬∞</span></div>
    {{if .TempChangeRate}}
    <div class="temp-trend {{if gt (deref .TempChangeRate) 0.0}}rising{{else}}falling{{end}}">
        {{if gt (deref .TempChangeRate) 0.0}}+{{else}}-{{end}}{{printf "%.1f" (abs (deref .TempChangeRate))}}¬∞C/hr
    </div>
    {{end}}
    {{if .Primary}}
    <div class="conditions-inline">
        {{if .Primary.Humidity.Valid}}<span>Humidity {{.Primary.Humidity.Int64}}%</span>{{end}}
        {{if .FeelsLike}}<span>Feels {{printf "%.0f" (deref .FeelsLike)}}¬∞</span>{{end}}
        {{if .Primary.Dewpoint.Valid}}<span>Dew {{printf "%.0f" .Primary.Dewpoint.Float64}}¬∞</span>{{end}}
        {{if .Primary.WindGust.Valid}}<span>üí® {{printf "%.0f" .Primary.WindGust.Float64}} km/h</span>{{end}}
        {{if .Primary.UV.Valid}}{{if gt .Primary.UV.Float64 0.0}}<span>‚òÄÔ∏è UV {{printf "%.0f" .Primary.UV.Float64}}</span>{{else if .Moon}}<span>{{.Moon.Emoji}} {{.Moon.Illumination}}%</span>{{end}}{{end}}
    </div>
    {{end}}
    {{else}}
    <div class="temp-now">‚Äî<span class="unit">¬∞</span></div>
    {{end}}
</div>

<!-- TODAY: Forecast -->
{{if .TodayForecast}}
<div class="today-forecast">
    <div class="forecast-header" onclick="document.getElementById('forecast-explain').classList.toggle('show')">Today's Forecast <span class="info-icon" title="Click for details">‚ìò</span></div>
    <div class="forecast-narrative">{{.TodayForecast.Narrative}}</div>
    <div class="forecast-range">
        <div class="range-item">
            <span class="range-value low">{{printf "%.0f" .TodayForecast.TempMin}}¬∞</span>
            <span class="range-label">Low</span>
        </div>
        <div class="range-item">
            <span class="range-value high">{{if and .TodayForecast.NowcastApplied (ne .TodayForecast.TempMaxPreNowcast .TodayForecast.TempMax)}}<span class="revised-from" title="Revised based on morning observations">{{printf "%.0f" .TodayForecast.TempMaxPreNowcast}}¬∞</span>{{end}}{{printf "%.0f" .TodayForecast.TempMax}}¬∞</span>
            <span class="range-label">High</span>
        </div>
        {{if .TodayForecast.HasPrecip}}
        <div class="range-item">
            <span class="range-value rain">{{.TodayForecast.PrecipChance}}%</span>
            <span class="range-label">Rain</span>
        </div>
        {{end}}
    </div>
    <div id="forecast-explain" class="forecast-explanation">
        <div class="explain-title">How this forecast is calculated</div>
        <div class="explain-row">
            <span class="explain-label">High:</span>
            <span class="explain-value">
                {{printf "%.0f" .TodayForecast.Explanation.MaxRaw}}¬∞ ({{.TodayForecast.Explanation.MaxSource | upper}})
                {{if ne .TodayForecast.Explanation.MaxBiasApplied 0.0}} ‚Üí {{printf "%+.1f" (neg .TodayForecast.Explanation.MaxBiasApplied)}}¬∞ correction{{end}}
                {{if .TodayForecast.NowcastApplied}} ‚Üí {{printf "%+.1f" .TodayForecast.Explanation.MaxNowcast}}¬∞ nowcast{{end}}
                = <strong>{{printf "%.0f" .TodayForecast.Explanation.MaxFinal}}¬∞</strong>
            </span>
        </div>
        {{if ge .TodayForecast.Explanation.MaxBiasDayUsed 0}}
        <div class="explain-detail">
            Correction based on {{.TodayForecast.Explanation.MaxBiasSamples}} days of local data{{if .TodayForecast.Explanation.MaxBiasFallback}} (using day-{{.TodayForecast.Explanation.MaxBiasDayUsed}} stats){{end}}
        </div>
        {{else}}
        <div class="explain-detail explain-warning">
            No correction applied (insufficient data)
        </div>
        {{end}}
        <div class="explain-row">
            <span class="explain-label">Low:</span>
            <span class="explain-value">
                {{printf "%.0f" .TodayForecast.Explanation.MinRaw}}¬∞ ({{.TodayForecast.Explanation.MinSource | upper}})
                {{if ne .TodayForecast.Explanation.MinBiasApplied 0.0}} ‚Üí {{printf "%+.1f" (neg .TodayForecast.Explanation.MinBiasApplied)}}¬∞ correction{{end}}
                = <strong>{{printf "%.0f" .TodayForecast.Explanation.MinFinal}}¬∞</strong>
            </span>
        </div>
        {{if ge .TodayForecast.Explanation.MinBiasDayUsed 0}}
        <div class="explain-detail">
            Correction based on {{.TodayForecast.Explanation.MinBiasSamples}} days of local data{{if .TodayForecast.Explanation.MinBiasFallback}} (using day-{{.TodayForecast.Explanation.MinBiasDayUsed}} stats){{end}}
        </div>
        {{else}}
        <div class="explain-detail explain-warning">
            No correction applied (insufficient data)
        </div>
        {{end}}
    </div>
    {{if .TodayStats}}
    <div class="observed-progress">
        So far: <span class="obs-temp" {{if .TodayStats.MinTempTime}}title="at {{.TodayStats.MinTempTime}}"{{end}}>{{printf "%.0f" .TodayStats.MinTemp}}¬∞</span> ‚Äì <span class="obs-temp" {{if .TodayStats.MaxTempTime}}title="at {{.TodayStats.MaxTempTime}}"{{end}}>{{printf "%.0f" .TodayStats.MaxTemp}}¬∞</span>{{if .TodayStats.HasWind}}, max {{if gt .TodayStats.MaxGust .TodayStats.MaxWind}}{{printf "%.0f" .TodayStats.MaxGust}}{{else}}{{printf "%.0f" .TodayStats.MaxWind}}{{end}} km/h winds{{end}}{{if .TodayStats.HasRain}}, {{printf "%.1f" .TodayStats.RainTotal}}mm rain{{end}}
    </div>
    {{end}}
</div>
{{end}}

{{if .Inversion}}
{{if .Inversion.Active}}
<div class="inversion active">
    <div class="inversion-title">‚ö†Ô∏è Inversion Active</div>
    <div class="inversion-detail">
        Valley {{printf "%.1f" .Inversion.ValleyAvg}}¬∞ ¬∑ Upper {{printf "%.1f" .Inversion.UpperAvg}}¬∞ 
        ({{printf "%+.1f" .Inversion.Strength}}¬∞ anomaly)
    </div>
</div>
{{end}}
{{end}}

<div class="forecast-section" hx-get="/partials/forecast" hx-trigger="load, every 3600s" hx-swap="innerHTML"></div>

<div class="chart-toggle">
    <a onclick="toggleChart()">Show 24hr chart</a>
</div>

<div id="chart-section" class="chart-section" hx-get="/partials/chart" hx-trigger="revealed" hx-swap="innerHTML"></div>

<div class="stations-toggle">
    <a onclick="toggleStations()">Show all stations</a>
</div>

<div id="stations-grid" class="stations-grid">
    <div class="stations-table">
        <div class="station-header">
            <span class="station-col-name">Station</span>
            <span class="station-col-temp">Temp</span>
            <span class="station-col-elev">Elev</span>
            <span class="station-col-coords">Location</span>
        </div>
        {{range .AllStations}}
        <div class="station-row{{if .Station.IsPrimary}} primary{{end}}">
            <span class="station-col-name">
                <a href="https://www.wunderground.com/dashboard/pws/{{.Station.StationID}}" target="_blank" rel="noopener">{{.Station.StationID}}</a>
                <span class="station-label">{{.Station.Name}}</span>
            </span>
            <span class="station-col-temp">{{if .Obs}}{{if .Obs.Temp.Valid}}{{printf "%.1f" .Obs.Temp.Float64}}¬∞{{else}}‚Äî{{end}}{{else}}‚Äî{{end}}</span>
            <span class="station-col-elev">{{printf "%.0f" .Station.Elevation}}m</span>
            <span class="station-col-coords">
                <a href="https://www.google.com/maps?q={{.Station.Latitude}},{{.Station.Longitude}}" target="_blank" rel="noopener">{{printf "%.3f" .Station.Latitude}}, {{printf "%.3f" .Station.Longitude}}</a>
            </span>
        </div>
        {{end}}
    </div>
</div>

<div class="updated">
    Updated {{.LastUpdated.Format "3:04:05 PM"}} ¬∑ <a href="/accuracy">Forecast accuracy</a> ¬∑ <a href="mailto:lachlan@ljd.cc">Email me</a>
    {{if .Alerts}}<br><a href="https://emergency.vic.gov.au" target="_blank" rel="noopener">Emergency data: State of Victoria</a>{{end}}
</div>
